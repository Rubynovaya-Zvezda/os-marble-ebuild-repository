From b4cfdd44688d9e81fc3e896bb5c059fa7b7a137b Mon Sep 17 00:00:00 2001
From: danilanosikov <danilanosikov@yandex.ru>
Date: Thu, 26 Sep 2024 04:09:08 +0300
Subject: [PATCH 1/1] fx

---
 Makefile        | 13 +++++++++----
 keyd.openrc.in  |  8 ++++++++
 keyd.systemd.in |  9 +++++++++
 3 files changed, 26 insertions(+), 4 deletions(-)
 create mode 100644 keyd.openrc.in
 create mode 100644 keyd.systemd.in

diff --git a/Makefile b/Makefile
index b4fc2bc..5e50a2f 100644
--- a/Makefile
+++ b/Makefile
@@ -34,7 +34,7 @@ endif
 all:
 	-mkdir bin
 	cp scripts/keyd-application-mapper bin/
-	sed -e 's#@PREFIX@#$(PREFIX)#' keyd.service.in > keyd.service
+	sed -e 's#@PREFIX@#$(PREFIX)#' keyd.systemd.in > keyd.service
 	sed -e 's#@PREFIX@#$(PREFIX)#' src/vkbd/usb-gadget.service.in > src/vkbd/usb-gadget.service
 	$(CC) $(CFLAGS) -O3 $(COMPAT_FILES) src/*.c src/vkbd/$(VKBD).c -lpthread -o bin/keyd $(LDFLAGS)
 debug:
@@ -53,7 +53,14 @@ install:
 		mkdir -p $(DESTDIR)$(PREFIX)/lib/systemd/system/; \
 		install -Dm644 keyd.service $(DESTDIR)$(PREFIX)/lib/systemd/system/keyd.service; \
 	else \
-		echo "NOTE: systemd not found, you will need to manually add keyd to your system's init process."; \
+		echo "NOTE: systemd not found."; \
+	fi
+
+	@if [ -e /run/openrc ]; then \
+			cp keyd.openrc.in keyd.svc; \
+			chmod +x keyd.svc;
+	else \
+			echo "NOTE: openrc not found."; \
 	fi
 
 	@if [ "$(VKBD)" = "usb-gadget" ]; then \
@@ -69,7 +76,6 @@ install:
 	mkdir -p $(DESTDIR)$(PREFIX)/share/doc/keyd/
 	mkdir -p $(DESTDIR)$(PREFIX)/share/doc/keyd/examples/
 
-	-groupadd keyd
 	install -m755 bin/* $(DESTDIR)$(PREFIX)/bin/
 	install -m644 docs/*.md $(DESTDIR)$(PREFIX)/share/doc/keyd/
 	install -m644 examples/* $(DESTDIR)$(PREFIX)/share/doc/keyd/examples/
@@ -79,7 +85,6 @@ install:
 	install -m644 data/keyd.compose $(DESTDIR)$(PREFIX)/share/keyd/
 
 uninstall:
-	-groupdel keyd
 	rm -rf $(DESTDIR)$(PREFIX)/lib/systemd/system/keyd.service \
 		$(DESTDIR)$(PREFIX)/bin/keyd \
 		$(DESTDIR)$(PREFIX)/bin/keyd-application-mapper \
diff --git a/keyd.openrc.in b/keyd.openrc.in
new file mode 100644
index 0000000..4a8d68b
--- /dev/null
+++ b/keyd.openrc.in
@@ -0,0 +1,8 @@
+#!/sbin/openrc-run
+
+name="keyd"
+description="key remapping daemon"
+command="keyd"
+command_background=true
+command_user=root:root
+pidfile="/run/keyd.pid"
diff --git a/keyd.systemd.in b/keyd.systemd.in
new file mode 100644
index 0000000..a4c90bb
--- /dev/null
+++ b/keyd.systemd.in
@@ -0,0 +1,9 @@
+[Unit]
+Description=key remapping daemon
+
+[Service]
+Type=simple
+ExecStart=@PREFIX@/bin/keyd
+
+[Install]
+WantedBy=multi-user.target
-- 
2.45.2

